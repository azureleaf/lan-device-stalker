<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
</head>
<body>
  <script src="https://d3js.org/d3.v4.js"></script>
  <div id="device_occurence_chart"></div>

  <script src="./devices.js"></script>
  <script src="./history.js"></script>

  <script>
    // set the dimensions and margins of the graph
    var margin = { top: 30, right: 30, bottom: 30, left: 100 },
      // width:height ratio can be changed
      // chart will be stretched, but text labels won't be
      width = 2000 - margin.left - margin.right,
      height = 800 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3
      .select("#device_occurence_chart") // getElementById() equivalent
      .append("svg") // appendChild() equivalent
      .attr("width", width + margin.left + margin.right) // setAttribute() equivalent
      .attr("height", height + margin.top + margin.bottom)
      .append("g") // <g> is a tag to group graphic elements (<line>, <rect>, etc.) inside <svg>
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")"); // SVG offset

    // Format the device occurence history for D3.js
    const recordsByOccurence = (function formatRecords(devices) {
      occs4all = [];

      // Loop for all the devices
      devices.forEach((device) => {
        // Destructure the occurences for this device
        device.occ.forEach((timestamp) => {
          occs4all.push({
            group: timestamp,
            variable: device.mac_addr,
            value: 1,
          });
        });
      });
      return occs4all;
    })(
      recordsByDevice // from history.js
    );

    // Build X scales and axis: use the values from history.js
    var x = d3.scaleBand().range([0, width]).domain(timestamps).padding(0.01);

    svg
      .append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

    // Build X scales and axis:
    var y = d3
      .scaleBand() // very basic scale
      .range([height, 0])
      .domain(macAddrs) // y-label
      .padding(0.01); // gap between tiles
    svg.append("g").call(d3.axisLeft(y)); // .call() is used to apply func(s) to selections

    // Build color scale
    var myColor = d3.scaleLinear().range(["white", "orange"]).domain([0, 1]);

    //Read the data
    (function readData(data) {
      svg
        .selectAll()
        .data(data, function (d) {
          return d.group + ":" + d.variable;
        })
        .enter()
        .append("rect")
        .attr("x", function (d) {
          return x(d.group);
        })
        .attr("y", function (d) {
          return y(d.variable);
        })
        .attr("width", x.bandwidth())
        .attr("height", y.bandwidth())
        .style("fill", function (d) {
          return myColor(d.value);
        });
    })(recordsByOccurence);
  </script>
</body>
